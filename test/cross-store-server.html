<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Cross Store Server</title>
<script>
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["easy-local-store"]=t():e["easy-local-store"]=t()}(window,function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=2)}([function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(3);t.LocalStorageDriver=n.LocalStorageDriver;var o=r(4);t.CrossStorageClientDriver=o.CrossStorageClientDriver,t.CrossStorageServerDriver=o.CrossStorageServerDriver},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.GET="GET",e.SET="SET",e.REMOVE="REMOVE",e.CLEAR="CLEAR"}(t.Method||(t.Method={}))},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(0);t.CrossStorageClientDriver=n.CrossStorageClientDriver,t.CrossStorageServerDriver=n.CrossStorageServerDriver,t.LocalStorageDriver=n.LocalStorageDriver;var o=r(8);t.EasyLocalStore=o.EasyLocalStore,window.CrossStorageServerDriver=n.CrossStorageServerDriver},function(e,t,r){"use strict";var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(o,i){function s(e){try{u(n.next(e))}catch(e){i(e)}}function a(e){try{u(n.throw(e))}catch(e){i(e)}}function u(e){e.done?o(e.value):new r(function(t){t(e.value)}).then(s,a)}u((n=n.apply(e,t||[])).next())})},o=this&&this.__generator||function(e,t){var r,n,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}};Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){this._localStorage=window.localStorage}return Object.defineProperty(e.prototype,"name",{get:function(){return"localstorageDriver"},enumerable:!0,configurable:!0}),e.prototype.getItem=function(e){return n(this,void 0,void 0,function(){var t;return o(this,function(r){return t=this._localStorage,[2,new Promise(function(r){r(t.getItem(e))})]})})},e.prototype.setItem=function(e,t){return n(this,void 0,void 0,function(){var r;return o(this,function(n){return r=this._localStorage,[2,new Promise(function(n){r.setItem(e,t),n()})]})})},e.prototype.removeItem=function(e){return n(this,void 0,void 0,function(){var t;return o(this,function(r){return t=this._localStorage,[2,new Promise(function(r){t.removeItem(e),r()})]})})},e}();t.LocalStorageDriver=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(5);t.CrossStorageClientDriver=n.CrossStorageClientDriver;var o=r(6);t.CrossStorageServerDriver=o.CrossStorageServerDriver},function(e,t,r){"use strict";var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(o,i){function s(e){try{u(n.next(e))}catch(e){i(e)}}function a(e){try{u(n.throw(e))}catch(e){i(e)}}function u(e){e.done?o(e.value):new r(function(t){t(e.value)}).then(s,a)}u((n=n.apply(e,t||[])).next())})},o=this&&this.__generator||function(e,t){var r,n,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}};Object.defineProperty(t,"__esModule",{value:!0});var i=r(1),s=function(){function e(e){var t=this;this._cbId=0,this._cbRecord={},this._isConnected=!1,this._iframeBeforeFuns=[],this._clientWin=window,this._clientWin.addEventListener("message",function(e){t._onReceiveResponseMsg(e)}),this._createIframe(e)}return e.prototype._getCbId=function(){return this._cbId+=1},e.prototype._createIframe=function(e){var t=this,r=document.createElement("iframe");r.id="cros_iframe",r.style.cssText="width:1px;height:1px;border:0;position:absolute;left:-9999px;top:-9999px;",r.setAttribute("src",e),r.onload=function(){t._serverWin=r.contentWindow,t._isConnected=!0,t._iframeBeforeFuns.forEach(function(e){return e()})},document.body.appendChild(r)},e.prototype._onReceiveResponseMsg=function(e){var t=JSON.parse(e.data),r=t.cbId,n=(t.ret,this._cbRecord[r]),o=n.reject,i=n.resolve;delete this._cbRecord[r],t.err?o(t.err):i(t.ret)},e.prototype._tryPostMessage=function(e,t){var r=this;return new Promise(function(n){if(r._isConnected)return r._postMessage(e,t).then(n);r._iframeBeforeFuns.push(function(){r._postMessage(e,t).then(n)})})},e.prototype._postMessage=function(e,t){return n(this,void 0,void 0,function(){var r,n,i=this;return o(this,function(o){return r=this._getCbId(),n={cbId:r,origin:"*",method:e,args:t},this._serverWin.postMessage(JSON.stringify(n),"*"),[2,new Promise(function(e,t){i._cbRecord[r]={resolve:e,reject:t}})]})})},Object.defineProperty(e.prototype,"name",{get:function(){return"cross store client!"},enumerable:!0,configurable:!0}),e.prototype.setItem=function(e,t){return n(this,void 0,void 0,function(){return o(this,function(r){switch(r.label){case 0:return[4,this._tryPostMessage(i.Method.SET,[e,t])];case 1:return r.sent(),[2,Promise.resolve()]}})})},e.prototype.getItem=function(e){return n(this,void 0,void 0,function(){return o(this,function(t){return[2,this._tryPostMessage(i.Method.GET,[e])]})})},e.prototype.removeItem=function(e){return n(this,void 0,void 0,function(){return o(this,function(t){switch(t.label){case 0:return[4,this._tryPostMessage(i.Method.REMOVE,[e])];case 1:return t.sent(),[2,Promise.resolve(null)]}})})},e}();t.CrossStorageClientDriver=s},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(1),o=r(7),i=function(){function e(e){var t=this;o.addEvent("message",function(e){return t._onReceiveRequestMsg(e)})}return e.prototype._onReceiveRequestMsg=function(e){var t=JSON.parse(e.data),r=t.method,o=t.cbId,i=t.args,s=i[0],a=i[1],u=null;switch(r){case n.Method.GET:u=this.get(s);break;case n.Method.SET:this.set(s,a);break;case n.Method.REMOVE:this.remove(s);break;case n.Method.CLEAR:this.clear();break;default:console.error("不支持的Method，"+r)}var c={cbId:o,ret:u};window.top.postMessage(JSON.stringify(c),"*")},e.prototype.set=function(e,t){localStorage.setItem(e,t)},e.prototype.get=function(e){return localStorage.getItem(e)},e.prototype.remove=function(e){localStorage.removeItem(e)},e.prototype.clear=function(){localStorage.clear()},e}();t.CrossStorageServerDriver=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addEvent=function(e,t){window.addEventListener(e,t)}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(9);t.EasyLocalStore=n.EasyLocalStore},function(e,t,r){"use strict";var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(o,i){function s(e){try{u(n.next(e))}catch(e){i(e)}}function a(e){try{u(n.throw(e))}catch(e){i(e)}}function u(e){e.done?o(e.value):new r(function(t){t(e.value)}).then(s,a)}u((n=n.apply(e,t||[])).next())})},o=this&&this.__generator||function(e,t){var r,n,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}};Object.defineProperty(t,"__esModule",{value:!0});var i=r(0),s=r(10),a=function(){function e(e){var t=e.namespace,r=e.isCros,n=e.serverUrl;if(this._namespacePrefix=t,this._isCros=r,this._serverUrl=n,r){if(!n)throw"Store when open cros, must config serverUrl";this._storageDriver=new i.CrossStorageClientDriver(n)}else this._storageDriver=new i.LocalStorageDriver}return e.prototype.write=function(e,t){return n(this,void 0,void 0,function(){var r;return o(this,function(n){switch(n.label){case 0:return e=this._addNamespacePrefix(e),r=s.serialize(t),[4,this._storageDriver.setItem(e,r)];case 1:return n.sent(),[2]}})})},e.prototype.read=function(e,t){return void 0===t&&(t=null),n(this,void 0,void 0,function(){var r;return o(this,function(n){switch(n.label){case 0:return e=this._addNamespacePrefix(e),[4,this._storageDriver.getItem(e)];case 1:return r=n.sent(),[2,s.deserialize(r)||t]}})})},e.prototype.remove=function(e){return n(this,void 0,void 0,function(){return o(this,function(t){return e=this._addNamespacePrefix(e),[2,this._storageDriver.removeItem(e)]})})},e.prototype._addNamespacePrefix=function(e){return this._namespacePrefix+"_"+e},e}();t.EasyLocalStore=a},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.serialize=function(e){return JSON.stringify(e)},t.deserialize=function(e,t){return void 0===t&&(t=void 0),e&&JSON.parse(e)||t}}])});
</script>
</head>
<body>
  Cross Store Server
</body>
<script>
  const CrossStorageServerDriver = window.CrossStorageServerDriver;
  const server = new CrossStorageServerDriver();
</script>
</html>
